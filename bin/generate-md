#!/usr/bin/env node
var fs = require('fs'),
    path = require('path'),
    Gen = require('../lib/generate.js');

var cwd = process.cwd();

if(!fs.existsSync('./input/')) {
  console.log('./input/ does not exist');
  process.exit();
}

// Load the layout: header, footer
var layout = 'jasonm23-markdown',
    header = (fs.existsSync(cwd + '/layouts/'+layout+'/header.html') ?
                cwd + '/layouts/'+layout+'/header.html' : cwd + '/layouts/plain/header.html'),
    footer = (fs.existsSync(cwd + '/layouts/'+layout+'/footer.html') ?
                cwd + '/layouts/'+layout+'/footer.html' : cwd + '/layouts/plain/footer.html');

console.log('Layout: ' + layout);
console.log('- header: ' + header);
console.log('- footer: ' + footer);

// read in the header and footer
header = fs.readFileSync(header).toString();
footer = fs.readFileSync(footer).toString();

function replace(items, str) {
  var result = str;
  Object.keys(items).forEach(function(key) {
    result = result.replace(new RegExp('{{'+key+'}}'), items[key]);
  });
  return result;
}

// run the generator for each directory
new Gen({ output: './output/'+layout+'/' })
  // Recurse through ./input/**/*
  .paths('./input/')
  // default metadata
  .defaultMeta({
    title: 'example'
  })

//  .sort()
  .each(function(sourceFile, targetFile, content, meta) {
    var title = '';
    /*
    var title = config.titles[path.basename(current.filename, '.md') ];
    content = content.replace(/%chapter_number%/g, current.index);
    */
    console.log(sourceFile, '->', targetFile);

    fs.writeFileSync(targetFile,
      replace(meta, header) +
      content +
      replace(meta, footer)
    );
  });
